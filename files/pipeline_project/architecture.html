<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Architecture &amp; Ops</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0b0e;
      --card: #141a22;
      --text: #f1f5f9;
      --muted: #a5b0bf;
      --brand: #66e3c4;
      --brand-2: #4fa8ff;
      --line: #1f2733;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Space Grotesk", "Segoe UI", Arial, sans-serif;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(79,168,255,0.15), transparent 60%),
        radial-gradient(800px 500px at 90% 20%, rgba(102,227,196,0.12), transparent 50%),
        var(--bg);
      color: var(--text);
      line-height: 1.6;
      margin: 0;
      padding: 24px;
    }
    .wrap { max-width: 1200px; margin: 0 auto; }
    h1 { margin: 0 0 6px; font-size: 2rem; }
    h2 { font-size: 1.2rem; margin: 28px 0 12px; border-bottom: 1px solid var(--line); padding-bottom: 6px; }
    h3 { font-size: 1rem; margin: 18px 0 8px; }
    p { color: var(--muted); }
    .nav {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 16px 0 24px;
    }
    .nav a {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(79,168,255,0.15);
      border: 1px solid rgba(79,168,255,0.35);
      border-radius: 12px;
      padding: 8px 12px;
      color: var(--text);
      font-weight: 600;
      text-decoration: none;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }
    .nav a:hover { transform: translateY(-1px); border-color: rgba(102,227,196,0.5); }
    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }
    .card:hover { transform: translateY(-2px); border-color: rgba(79,168,255,0.35); }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(102,227,196,0.08);
      border: 1px solid rgba(102,227,196,0.3);
      border-radius: 999px;
      padding: 4px 12px;
      margin: 6px 8px 0 0;
      color: var(--muted);
      font-size: 0.85rem;
    }
    .mono { font-family: "IBM Plex Mono", "Courier New", monospace; font-size: 0.85rem; color: var(--muted); }
    pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      color: var(--muted);
    }
    .mermaid {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
    }
    details {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px 16px;
      margin-top: 12px;
    }
    details summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--text);
    }
    .cta-row { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 18px; }
    .cta {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(79,168,255,0.15);
      border: 1px solid rgba(79,168,255,0.35);
      border-radius: 12px;
      padding: 8px 12px;
      color: var(--text);
      font-weight: 600;
      text-decoration: none;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }
    .cta:hover { transform: translateY(-1px); border-color: rgba(102,227,196,0.5); }
    @media (max-width: 700px) {
      h1 { font-size: 1.6rem; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Architecture &amp; Ops</h1>
    <p>Medallion lakehouse pipeline from Bronze ingestion through Gold marts, with layered validation and atomic publishing.</p>

    <div>
      <span class="pill"><strong>Bronze</strong> immutable source</span>
      <span class="pill"><strong>Silver</strong> contracts + quarantine</span>
      <span class="pill"><strong>Gold</strong> BI marts</span>
      <span class="pill"><strong>Validation</strong> 3-layer gates</span>
    </div>

    <div class="nav">
      <a href="#high-level">High-Level Flow</a>
      <a href="#pipeline">Pipeline Flow</a>
      <a href="#validation">Validation</a>
      <a href="#airflow">Airflow DAGs</a>
      <a href="#specs">Spec-Driven</a>
      <a href="#observability">Observability</a>
      <a href="#performance">Performance</a>
    </div>

    <section id="high-level">
      <h2>High-Level Data Flow</h2>
      <div class="grid">
        <div class="card">
          <h3>Bronze</h3>
          <p class="mono">Partitioned Parquet + _MANIFEST.json lineage</p>
        </div>
        <div class="card">
          <h3>Silver</h3>
          <p class="mono">dbt-duckdb Base Silver + Polars Enriched</p>
        </div>
        <div class="card">
          <h3>Gold</h3>
          <p class="mono">BigQuery marts + partition idempotency</p>
        </div>
      </div>
      <details>
        <summary>Mermaid diagram</summary>
        <div class="mermaid">flowchart TD
  subgraph Bronze["Bronze Layer (GCS)"]
    B1[Partitioned Parquet]
    B2[_MANIFEST.json]
  end
  subgraph Validation["Three-Layer Validation"]
    V1[Bronze Quality]
    V2[Silver Quality]
    V3[Enriched Quality]
  end
  subgraph Silver["Silver Layer (Local/GCS)"]
    S1[Base Silver dbt-duckdb]
    S2[Dimension Snapshots customers, products]
    S3[Enriched Silver Polars transforms]
  end
  subgraph Gold["Gold Layer (BigQuery)"]
    G1[Fact Tables]
    G2[Dimension Tables]
  end
  Bronze -->|Validate| V1
  V1 -->|Pass| S1
  S1 -->|Generate| S2
  S1 -->|Validate| V2
  V2 -->|Pass| S3
  S3 -->|Validate| V3
  V3 -->|Pass| Gold
  S1 -.->|Quarantine| Q[Quarantine Tables]</div>
      </details>
    </section>

    <section id="pipeline">
      <h2>Detailed Pipeline Flow</h2>
      <details>
        <summary>Mermaid diagram</summary>
        <div class="mermaid">flowchart LR
  subgraph Input["Bronze Input"]
    B1[Raw Parquet partitioned by ingest_dt]
    B2[Lineage Metadata _MANIFEST.json]
  end
  subgraph Dims["Dimension Snapshots"]
    D1{Dims Fresh?}
    D2[Snapshot Customers]
    D3[Snapshot Products]
    D4[_latest.json pointer]
  end
  subgraph BaseSilver["Base Silver dbt-duckdb"]
    BS1[Type Casting & Cleaning]
    BS2[Deduplication]
    BS3[PK/FK Validation]
    BS4[Quarantine Rejects]
  end
  subgraph EnrichedSilver["Enriched Silver Polars"]
    ES1[Cart Attribution]
    ES2[Customer LTV]
    ES3[Product Performance]
    ES4[Daily Metrics]
    ES5[10 transforms total]
  end
  subgraph GCS["GCS Publish"]
    GCS1[Staging Prefix _staging/run_id/]
    GCS2[Atomic Publish]
    GCS3[Manifest + Pointer]
  end
  subgraph BQ["BigQuery Load"]
    BQ1[Parquet Import WRITE_TRUNCATE]
    BQ2[Partition-level Idempotency]
  end
  subgraph GoldMarts["Gold Marts dbt-bigquery"]
    GM1[Fact: Orders]
    GM2[Fact: Customers]
    GM3[8 fact tables]
  end
  Input --> Dims
  D1 -->|Stale| D2 & D3
  D2 & D3 --> D4
  D1 -->|Fresh| BaseSilver
  D4 --> BaseSilver
  BaseSilver --> ES1 & ES2 & ES3 & ES4 & ES5
  ES5 --> GCS1
  GCS1 --> GCS2
  GCS2 --> GCS3
  GCS3 --> BQ1
  BQ1 --> BQ2
  BQ2 --> GM1 & GM2 & GM3
  BS4 -.->|Rejected Rows| QT[Quarantine Tables]</div>
      </details>
    </section>

    <section id="validation">
      <h2>Three-Layer Validation Framework</h2>
      <div class="grid">
        <div class="card">
          <h3>Bronze Validation</h3>
          <p class="mono">Manifest exists, row counts, schema conformance, coverage</p>
        </div>
        <div class="card">
          <h3>Silver Validation</h3>
          <p class="mono">PK/FK integrity, quarantine rate, row loss thresholds</p>
        </div>
        <div class="card">
          <h3>Enriched Validation</h3>
          <p class="mono">Business rules, min rows, null analysis</p>
        </div>
      </div>
    </section>

    <section id="airflow">
      <h2>Airflow DAG Architecture</h2>
      <div class="grid">
        <div class="card">
          <h3>Dim Refresh Pipeline</h3>
          <p class="mono">Freshness gates, parallel snapshots, lightweight validation.</p>
        </div>
        <div class="card">
          <h3>Silver to Gold Pipeline</h3>
          <p class="mono">Full Bronze → Gold with validation stages and optional BigQuery load.</p>
        </div>
      </div>
      <div class="grid" style="margin-top: 16px;">
        <figure class="card">
          <img src="./airflow_ui_01.png" alt="Airflow DAG orchestration overview" style="width:100%;border-radius:12px;border:1px solid var(--line);display:block;" />
          <figcaption class="mono" style="margin-top:8px;">Core pipeline DAG with Bronze → Silver → Gold dependencies.</figcaption>
        </figure>
        <figure class="card">
          <img src="./airflow_ui_02.png" alt="Airflow task graph with quality gates" style="width:100%;border-radius:12px;border:1px solid var(--line);display:block;" />
          <figcaption class="mono" style="margin-top:8px;">Quality gates embedded in task graph for early failure detection.</figcaption>
        </figure>
      </div>
      <div class="grid" style="margin-top: 16px;">
        <div class="card">
          <h3>Partition-level recovery</h3>
          <p class="mono">Backfill single partitions without replaying entire tables.</p>
        </div>
        <div class="card">
          <h3>Data quality enforcement</h3>
          <p class="mono">Fail fast on contract violations before downstream publish.</p>
        </div>
        <div class="card">
          <h3>Layered orchestration</h3>
          <p class="mono">Independent Bronze, Base Silver, Enriched Silver, Gold schedules.</p>
        </div>
      </div>
    </section>

    <section id="specs">
      <h2>Spec-Driven Orchestration</h2>
      <div class="card">
        <p class="mono">Specs define tables, partitions, PK/FK rules, and transform dependencies for dynamic DAG generation.</p>
        <pre class="mono">base_silver:
  tables:
    - name: orders
      partition_key: ingestion_dt
      primary_key: [order_id]
      foreign_keys:
        - column: customer_id
          references: customers.customer_id</pre>
      </div>
    </section>

    <section id="observability">
      <h2>Observability & Monitoring</h2>
      <div class="grid">
        <div class="card">
          <h3>Audit Trail</h3>
          <p class="mono">Per-table JSON audits for SLA dashboards and alerts.</p>
        </div>
        <div class="card">
          <h3>Validation Reports</h3>
          <p class="mono">Bronze, Silver, Enriched, and Dims snapshot reports.</p>
        </div>
        <div class="card">
          <h3>Structured Logging</h3>
          <p class="mono">Local logs + Airflow task logs with enriched context.</p>
        </div>
      </div>
    </section>

    <section id="performance">
      <h2>Performance Characteristics</h2>
      <div class="grid">
        <div class="card">
          <h3>Base Silver</h3>
          <p class="mono">&lt;2GB memory, under 2 minutes for 8 tables.</p>
        </div>
        <div class="card">
          <h3>Enriched Silver</h3>
          <p class="mono">&lt;6GB memory, under 5 minutes for 10 transforms.</p>
        </div>
        <div class="card">
          <h3>Gold Marts</h3>
          <p class="mono">Warehouse execution under 3 minutes for 8 facts.</p>
        </div>
      </div>
    </section>

    <section>
      <div class="cta-row">
        <a class="cta" href="./dbt_observability.html">dbt observability</a>
        <a class="cta" href="./architecture.html">Architecture &amp; Ops</a>
        <a class="cta" href="./metrics_snapshot.html">Metrics snapshot</a>
        <a class="cta" href="./data_contract.html">Data contract</a>
        <a class="cta" href="./data_dictionary.html">Data dictionary</a>
      </div>
    </section>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: 'base',
      themeVariables: {
        primaryColor: '#141a22',
        primaryBorderColor: '#1f2733',
        primaryTextColor: '#f1f5f9',
        lineColor: '#4fa8ff',
        fontFamily: 'Space Grotesk, Segoe UI, Arial, sans-serif'
      }
    });
  </script>
</body>
</html>
